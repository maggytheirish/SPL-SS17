---
title: "Data Preparation"
author: "Margarita"
date: "16/06/2017"
output: html_document
---
Loading the required packages
```{r}
load_packages  <- function(p){
  
  for(i in seq_along(p)) {
    if(!require(p[i], character.only=TRUE)) {
      install.packages(p[i])}
      library(p[i], character.only=TRUE)
  }

}

list.of.packages <- c("rpart","lubridate","outliers","rpart.plot", "xgboost",
                      "caret","randomForest","e1071","pROC", "tidyr", "klaR", 
                      "car","devtools","yamldebugger")

sapply(list.of.packages,load_packages)
```

Loading the datasets
```{r}

## Read in original dataset
store<-read.csv("store.csv", header=T, sep=",")
train<-read.csv("train.csv", header=T, sep=",")

## Creating separate test set 
train$Date<-as.Date(paste(train$Date,sep="-"),format= "%Y-%m-%d")
testdate <- train$Date>="2015-07-20" #Selecting the last 10 days for forecasting
test <- train[testdate==T,]
train <- train[testdate==F,] # remove test observations

## Creating train dataset
train$Date<- as.factor(train$Date)
set.seed(123)
idx <- createDataPartition(train$Date,p=0.05,list = F)
new_train <- train[idx,]
new_train$Date<-as.Date(new_train$Date)

## Check the datasets
summary(new_train)
summary(test)
```

Store dataset
Turning numeric variables into factor variables
```{r}
varlist_store<-c("StoreType", "Assortment", "Promo2")
store[,varlist_store]<-lapply(store[,varlist_store], factor)
```
Replacing a typo in CompetitionOpenSinceYear
```{r}
store$CompetitionOpenSinceYear<-gsub("1900", "2010", store$CompetitionOpenSinceYear)
```
Replacing empty category in PromoInterval with "missing"
```{r}
store$PromoInterval<-sub("^$", "missing", store$PromoInterval)
```

Starting date for Promo2
```{r}
store$Promo2SinceDate<-as.Date(with(store, paste(Promo2SinceYear,Promo2SinceWeek,1, sep="-")),"%Y-%U-%u")
```
Starting date for Competition (assuming it's from the first day of the month)
```{r}
store$CompetitionSinceDate<-as.Date(paste(store$CompetitionOpenSinceYear,store$CompetitionOpenSinceMonth,1, sep="-"),format="%Y-%m-%d")
```
Delete unnecessary columns
```{r}
store$CompetitionOpenSinceMonth<-NULL
store$CompetitionOpenSinceYear<-NULL
store$Promo2SinceWeek<-NULL
store$Promo2SinceYear<-NULL
```

Data Cleaning train & test
```{r}

## Change the data type 
str(new_train)
str(test)
varlist<-c("DayOfWeek", "Open", "Promo", "StateHoliday", "SchoolHoliday") # "Store" , keep store as integer for now 
new_train[,varlist]<-lapply(new_train[,varlist], factor)
test[,varlist]<-lapply(test[,varlist], factor)
```

```{r}
sapply(new_train,class)
summary(new_train)
```

Merging the datasets 
```{r}
train_set<-merge(store, new_train, by="Store")
test_set<-merge(store, test, by="Store")

summary(train_set)
```
#Replacing missing competition variables
```{r}
CompetitionDateMissing<-train_set[is.na(train_set$CompetitionSinceDate),]
CompetitionDateMissing<-CompetitionDateMissing[!is.na(CompetitionDateMissing$CompetitionDistance),]
CompetitionDateMissing$CompetitionSinceDate<-CompetitionDateMissing$Date
train_set[is.na(train_set$CompetitionSinceDate) & !is.na(train_set$CompetitionDistance),"CompetitionSinceDate"]<-CompetitionDateMissing$CompetitionSinceDate
train_set$CompetitionSinceDate<-as.Date(train_set$CompetitionSinceDate)

```

Create dummy variable for whether competition is present on a given day
```{r}
#indx<-as.Date(train_set$Date)<train_set$CompetitionSinceDate
train_set$CompetitionPresent<-ifelse(train_set$Date<train_set$CompetitionSinceDate,0,1)
train_set$CompetitionPresent<-as.factor(train_set$CompetitionPresent)
test_set$CompetitionPresent<-ifelse(test_set$Date<test_set$CompetitionSinceDate,0,1)
test_set$CompetitionPresent<-as.factor(test_set$CompetitionPresent)
# Train set
train_set$CompetitionPresent <- factor(train_set$CompetitionPresent, levels=c(levels(train_set$CompetitionPresent), "missing"))
form_na <- is.na(train_set$CompetitionPresent)
train_set[form_na,"CompetitionPresent"]<- "missing"
#Test set
test_set$CompetitionPresent <- factor(test_set$CompetitionPresent, levels=c(levels(test_set$CompetitionPresent), "missing"))
form_na <- is.na(test_set$CompetitionPresent)
test_set[form_na,"CompetitionPresent"]<- "missing"
```

Change date into a date format and separate in 3 columns
```{r}

train_set$Date<-as.Date(paste(train_set$Date,sep="-"),format= "%Y-%m-%d")
train_set <- separate(train_set, Date, into = c("Year", "Month", 
                                                "Day"), sep="-")
date_num<-c("Year", "Month", "Day")
train_set[,date_num]<-lapply(train_set[,date_num],as.integer)

## Test set

test_set$Date<-as.Date(paste(test_set$Date,sep="-"),format= "%Y-%m-%d")
test_set <- separate(test_set, Date, into = c("Year", "Month", 
                                                "Day"), sep="-")
test_set[,date_num]<-lapply(test_set[,date_num],as.integer)

```
```{r}
summary(train_set)
summary(test_set)
```
```{r}
test_set$Customers<-NULL
train_set$Customers<-NULL
test_set$Sales<-NULL
```

```{r}
test_set$Store<-as.integer(test_set$Store)
train_set$Store<-as.integer(train_set$Store)
```


