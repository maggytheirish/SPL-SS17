---
title: "Data preparation_store"
author: "Margarita"
date: "29/05/2017"
output: html_document
---
Loading the required packages
```{r}
load_packages  <- function(p){
  
  for(i in seq_along(p)) {
    if(!require(p[i], character.only=TRUE)) {
      install.packages(p[i])}
      library(p[i], character.only=TRUE)
  }

}

list.of.packages <- c("rpart","lubridate","outliers","rpart.plot", "xgboost",
                      "caret","randomForest","e1071","pROC", "tidyr", "klaR", 
                      "car","devtools","yamldebugger")

sapply(list.of.packages,load_packages)
```

Loading the dataset
```{r}
store<-read.csv("store.csv", header=T, sep=",")
```

Turning numeric variables into factor variables
```{r}
varlist_store<-c("Store", "StoreType", "Assortment", "Promo2")
store[,varlist_store]<-lapply(store[,varlist_store], factor)
```
Replacing a typo in CompetitionOpenSinceYear
```{r}
store$CompetitionOpenSinceYear<-gsub("1900", "2010", store$CompetitionOpenSinceYear)
```

Starting date for Promo2
```{r}
store$Promo2SinceDate<-as.Date(with(store, paste(Promo2SinceYear,Promo2SinceWeek,1, sep="-")),"%Y-%U-%u")
```
Starting date for Competition (assuming it's from the first day of the month)
```{r}
store$CompetitionSinceDate<-as.Date(paste(store$CompetitionOpenSinceYear,store$CompetitionOpenSinceMonth,1, sep="-"),format="%Y-%m-%d")
```
Delete unnecessary columns
```{r}
store$CompetitionOpenSinceMonth<-NULL
store$CompetitionOpenSinceYear<-NULL
store$Promo2SinceWeek<-NULL
store$Promo2SinceYear<-NULL
```
Merging two datasets by the common variable
```{r}

total<-total[,c("Store", "DayOfWeek", "Date", "Sales","Customers", "Open", "Promo", "StateHoliday", "SchoolHoliday", "StoreType", "Assortment", "CompetitionDistance", "Promo2", "PromoInterval","Promo2SinceDate", "CompetitionSinceDate")]
```
#Replacing missing competition variables
```{r}
CompetitionDateMissing<-train_set[is.na(train_set$CompetitionSinceDate),]
CompetitionDateMissing<-CompetitionDateMissing[!is.na(CompetitionDateMissing$CompetitionDistance),]
CompetitionDateMissing$CompetitionSinceDate<-CompetitionDateMissing$Date
train_set[is.na(train_set$CompetitionSinceDate) & !is.na(train_set$CompetitionDistance),"CompetitionSinceDate"]<-CompetitionDateMissing$CompetitionSinceDate
train_set$CompetitionSinceDate<-as.Date(train_set$CompetitionSinceDate)

```
Create dummy variable for whether competition is present on a given day
```{r}
#indx<-as.Date(train_set$Date)<train_set$CompetitionSinceDate
train_set$CompetitionPresent<-ifelse(train_set$Date<train_set$CompetitionSinceDate,0,1)
train_set$CompetitionPresent<-as.factor(train_set$CompetitionPresent)
#train_set$CompetitionPresent[indx & !is.na(indx)]<- 0
#train_set$CompetitionPresent[indx & is.na(indx)]<- 1
```
Create a dummy variable for whether there's a Promo 2 on a given day
```{r}
#Think about how to combine the starting date and interval
```

Change date into a date format and separate in 3 columns
```{r}
library(tidyr)
total$Date<-as.Date(paste(total$Date,sep="-"),format= "%Y-%m-%d")
total <- separate(total, Date, into = c("Year", "Month", 
                                                "Day"), sep="-")
date_num<-c("Year", "Month", "Day")
total[,date_num]<-lapply(total[,date_num],as.integer)
```

```{r}
summary(total)
```

Clustering stores by sales
```{r}
totalCluster <- kmeans(total[,c(6)],10,algorithm="Lloyd", iter.max=1000)
table(data.frame(total$Store, totalCluster$cluster))
```
